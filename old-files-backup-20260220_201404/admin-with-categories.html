<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ™ºèƒ½å•†å“è¯„æµ‹ç³»ç»Ÿ - å·²è¯„æµ‹å“ç±»ç›®å½•</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .category-item {
      transition: all 0.2s ease;
    }
    .category-item:hover {
      background-color: #f3f4f6;
      transform: translateY(-1px);
    }
    .search-highlight {
      background-color: #fef3c7;
      padding: 0 2px;
      border-radius: 2px;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen p-8">
  <div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ§  æ™ºèƒ½å•†å“è¯„æµ‹ç³»ç»Ÿ</h1>
        <p class="text-gray-600">å·²è¯„æµ‹å“ç±»ç›®å½• - å…± <span id="totalCount" class="font-bold text-blue-600">0</span> ä¸ªå“ç±»</p>
      </div>
      <div class="flex items-center space-x-4">
        <a href="http://localhost:3080/admin" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
          <i class="fas fa-cogs mr-2"></i>è¿”å›æ§åˆ¶é¢æ¿
        </a>
        <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
          <i class="fas fa-sync mr-2"></i>åˆ·æ–°æ•°æ®
        </button>
      </div>
    </div>

    <!-- æœç´¢å’Œç­›é€‰ -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex-1">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-gray-400"></i>
            </div>
            <input type="text" id="searchInput" placeholder="æœç´¢å“ç±»åç§°..." 
                   class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ä¸€çº§åˆ†ç±»</label>
            <select id="level1Filter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">å…¨éƒ¨</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">äºŒçº§åˆ†ç±»</label>
            <select id="level2Filter" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">å…¨éƒ¨</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">æ’åº</label>
            <select id="sortBy" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="name">æŒ‰åç§°æ’åº</option>
              <option value="recent">æœ€è¿‘è¯„æµ‹</option>
              <option value="level1">æŒ‰ä¸€çº§åˆ†ç±»</option>
            </select>
          </div>
        </div>
      </div>
      <div class="mt-4 flex items-center text-sm text-gray-500">
        <i class="fas fa-info-circle mr-2"></i>
        <span>ç‚¹å‡»å“ç±»åç§°å¯æŸ¥çœ‹è¯¦ç»†è¯„æµ‹ç»“æœï¼Œæ”¯æŒæœç´¢å’Œç­›é€‰åŠŸèƒ½</span>
      </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
            <i class="fas fa-boxes text-blue-600 text-xl"></i>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-800">æ€»å“ç±»æ•°</h3>
            <p class="text-3xl font-bold text-gray-900" id="statsTotal">0</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
            <i class="fas fa-check-circle text-green-600 text-xl"></i>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-800">å·²è¯„æµ‹</h3>
            <p class="text-3xl font-bold text-gray-900" id="statsEvaluated">0</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
            <i class="fas fa-layer-group text-purple-600 text-xl"></i>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-800">ä¸€çº§åˆ†ç±»</h3>
            <p class="text-3xl font-bold text-gray-900" id="statsLevel1">0</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-4">
            <i class="fas fa-tags text-yellow-600 text-xl"></i>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-800">äºŒçº§åˆ†ç±»</h3>
            <p class="text-3xl font-bold text-gray-900" id="statsLevel2">0</p>
          </div>
        </div>
      </div>
    </div>

    <!-- å“ç±»ç›®å½• -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-800">ğŸ“‹ å·²è¯„æµ‹å“ç±»ç›®å½•</h2>
        <div class="text-sm text-gray-500">
          æ˜¾ç¤º <span id="showingCount" class="font-bold">0</span> / <span id="totalCount2" class="font-bold">0</span> ä¸ªå“ç±»
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead>
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸€çº§åˆ†ç±»</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">äºŒçº§åˆ†ç±»</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å“ç±»åç§°</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¯„æµ‹æ—¶é—´</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="categoriesTable" class="divide-y divide-gray-200">
            <tr>
              <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                <div class="flex flex-col items-center">
                  <i class="fas fa-spinner fa-spin text-2xl text-blue-500 mb-2"></i>
                  <p>æ­£åœ¨åŠ è½½å“ç±»æ•°æ®...</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- åˆ†é¡µ -->
      <div class="mt-6 flex items-center justify-between" id="paginationContainer" style="display: none;">
        <div class="text-sm text-gray-700">
          æ˜¾ç¤ºç¬¬ <span id="pageStart">1</span> - <span id="pageEnd">20</span> æ¡ï¼Œå…± <span id="totalItems">0</span> æ¡
        </div>
        <div class="flex space-x-2">
          <button onclick="changePage(-1)" id="prevPage" disabled class="px-3 py-1 border border-gray-300 rounded text-gray-500 bg-gray-50">
            <i class="fas fa-chevron-left"></i>
          </button>
          <div class="flex items-center">
            <span id="currentPage" class="px-3 py-1">1</span>
            <span class="text-gray-500">/</span>
            <span id="totalPages" class="px-3 py-1">1</span>
          </div>
          <button onclick="changePage(1)" id="nextPage" disabled class="px-3 py-1 border border-gray-300 rounded text-gray-500 bg-gray-50">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- æœ€è¿‘è¯„æµ‹ -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ• æœ€è¿‘è¯„æµ‹çš„å“ç±»</h2>
      <div id="recentCategories" class="space-y-3">
        <div class="text-center text-gray-500 py-4">
          <i class="fas fa-spinner fa-spin mr-2"></i>åŠ è½½ä¸­...
        </div>
      </div>
    </div>
  </div>

  <script>
    let allCategories = [];
    let filteredCategories = [];
    let currentPage = 1;
    const itemsPerPage = 20;
    
    // åŠ è½½æ•°æ®
    async function loadData() {
      try {
        // åŠ è½½å·²è¯„æµ‹å“ç±»
        const response = await fetch('/api/evaluated-categories');
        const data = await response.json();
        
        // è½¬æ¢æ•°æ®ç»“æ„
        allCategories = [];
        Object.keys(data.grouped_categories || {}).forEach(level1 => {
          Object.keys(data.grouped_categories[level1]).forEach(level2 => {
            data.grouped_categories[level1][level2].forEach(item => {
              allCategories.push({
                level1,
                level2,
                item: item.item,
                title: item.title,
                updatedAt: item.updatedAt,
                evaluation_date: item.evaluation_date || item.updatedAt
              });
            });
          });
        });
        
        // æ›´æ–°ç»Ÿè®¡
        updateStats(data.total_categories);
        
        // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
        updateFilterOptions();
        
        // åº”ç”¨ç­›é€‰å’Œåˆ†é¡µ
        applyFilters();
        
        // åŠ è½½æœ€è¿‘è¯„æµ‹
        loadRecentCategories();
        
      } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        document.getElementById('categoriesTable').innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
              <div class="flex flex-col items-center text-red-500">
                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                <p>åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
              </div>
            </td>
          </tr>
        `;
      }
    }
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(total) {
      document.getElementById('totalCount').textContent = total;
      document.getElementById('totalCount2').textContent = total;
      document.getElementById('statsTotal').textContent = total;
      document.getElementById('statsEvaluated').textContent = total;
      
      // è®¡ç®—ä¸€çº§å’ŒäºŒçº§åˆ†ç±»æ•°é‡
      const level1Set = new Set();
      const level2Set = new Set();
      allCategories.forEach(cat => {
        level1Set.add(cat.level1);
        level2Set.add(`${cat.level1}-${cat.level2}`);
      });
      
      document.getElementById('statsLevel1').textContent = level1Set.size;
      document.getElementById('statsLevel2').textContent = level2Set.size;
    }
    
    // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
    function updateFilterOptions() {
      const level1Set = new Set(allCategories.map(cat => cat.level1));
      const level2Set = new Set(allCategories.map(cat => cat.level2));
      
      const level1Select = document.getElementById('level1Filter');
      const level2Select = document.getElementById('level2Filter');
      
      // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"å…¨éƒ¨"ï¼‰
      while (level1Select.options.length > 1) level1Select.remove(1);
      while (level2Select.options.length > 1) level2Select.remove(1);
      
      // æ·»åŠ ä¸€çº§åˆ†ç±»é€‰é¡¹
      Array.from(level1Set).sort().forEach(level1 => {
        const option = document.createElement('option');
        option.value = level1;
        option.textContent = level1;
        level1Select.appendChild(option);
      });
      
      // æ·»åŠ äºŒçº§åˆ†ç±»é€‰é¡¹
      Array.from(level2Set).sort().forEach(level2 => {
        const option = document.createElement('option');
        option.value = level2;
        option.textContent = level2;
        level2Select.appendChild(option);
      });
    }
    
    // åº”ç”¨ç­›é€‰
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const level1Filter = document.getElementById('level1Filter').value;
      const level2Filter = document.getElementById('level2Filter').value;
      const sortBy = document.getElementById('sortBy').value;
      
      // ç­›é€‰
      filteredCategories = allCategories.filter(cat => {
        // æœç´¢ç­›é€‰
        const matchesSearch = !searchTerm || 
          cat.item.toLowerCase().includes(searchTerm) ||
          cat.level1.toLowerCase().includes(searchTerm) ||
          cat.level2.toLowerCase().includes(searchTerm);
        
        // ä¸€çº§åˆ†ç±»ç­›é€‰
        const matchesLevel1 = !level1Filter || cat.level1 === level1Filter;
        
        // äºŒçº§åˆ†ç±»ç­›é€‰
        const matchesLevel2 = !level2Filter || cat.level2 === level2Filter;
        
        return matchesSearch && matchesLevel1 && matchesLevel2;
      });
      
      // æ’åº
      filteredCategories.sort((a, b) => {
        switch (sortBy) {
          case 'recent':
            return new Date(b.evaluation_date) - new Date(a.evaluation_date);
          case 'level1':
            if (a.level1 === b.level1) {
              if (a.level2 === b.level2) {
                return a.item.localeCompare(b.item);
              }
              return a.level2.localeCompare(b.level2);
            }
            return a.level1.localeCompare(b.level1);
          default: // name
            if (a.level1 === b.level1) {
              if (a.level2 === b.level2) {
                return a.item.localeCompare(b.item);
              }
              return a.level2.localeCompare(b.level2);
            }
            return a.level1.localeCompare(b.level1);
        }
      });
      
      // æ›´æ–°æ˜¾ç¤º
      updateTable();
    }
    
    // æ›´æ–°è¡¨æ ¼
    function updateTable() {
      const totalItems = filteredCategories.length;
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      
      // è®¡ç®—å½“å‰é¡µæ•°æ®
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
      const pageData = filteredCategories.slice(startIndex, endIndex);
      
      // æ›´æ–°æ˜¾ç¤ºè®¡æ•°
      document.getElementById('showingCount').textContent = pageData.length;
      document.getElementById('totalCount2').textContent = totalItems;
      
      // ç”Ÿæˆè¡¨æ ¼è¡Œ
      const tableBody = document.getElementById('categoriesTable');
      if (pageData.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-8 text-center text-gray-500">
              æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å“ç±»
            </td>
          </tr>
        `;
      } else {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        tableBody.innerHTML = pageData.map(cat => {
          // é«˜äº®æœç´¢è¯
          let displayItem = cat.item;
          let displayLevel1 = cat.level1;
          let displayLevel2 = cat.level2;
          
          if (searchTerm) {
            const highlight = text => text.replace(
              new RegExp(`(${searchTerm})`, 'gi'),
              '<span class="search-highlight">$1</span>'
            );
            displayItem = highlight(displayItem);
            displayLevel1 = highlight(displayLevel1);
            displayLevel2 = highlight(displayLevel2);
          }
          
          const date = new Date(cat.evaluation_date);
          const formattedDate = date.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          return `
            <tr class="category-item">
              <td class="px-4 py-3 text-sm text-gray-900">${displayLevel1}</td>
              <td class="px-4 py-3 text-sm text-gray-900">${displayLevel2}</td>
              <td class="px-4 py-3 text-sm font-medium text-gray-900">${displayItem}</td>
              <td class="px-4 py-3 text-sm text-gray-500">${formattedDate}</td>
              <td class="px-4 py-3 text-sm">
                <a href="http://localhost:3077/category/${encodeURIComponent(cat.level1)}/${encodeURIComponent(cat.level2)}/${encodeURIComponent(cat.item)}" 
                   target="_blank" class="text-blue-600 hover:text-blue-800 inline-flex items-center">
                  <i class="fas fa-external-link-alt mr-1"></i>æŸ¥çœ‹è¯¦æƒ…
                </a>
              </td>
            </tr>
          `;
        }).join('');
      }
      
      // æ›´æ–°åˆ†é¡µ
      updatePagination(totalItems, totalPages, startIndex, endIndex);
    }
    
    // æ›´æ–°åˆ†é¡µ
    function updatePagination(totalItems, totalPages, startIndex, endIndex) {
      const paginationContainer = document.getElementById('paginationContainer');
      if (totalItems > itemsPerPage) {
        paginationContainer.style.display = 'flex';
        
        document.getElementById('pageStart').textContent = startIndex + 1;
        document.getElementById('pageEnd').textContent = endIndex;
        document.getElementById('totalItems').textContent = totalItems;
        document.getElementById('currentPage').textContent = currentPage;
        document.getElementById('totalPages').textContent = totalPages;
        
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages;
      } else {
        paginationContainer.style.display = 'none';
      }
    }
    
    // åˆ‡æ¢é¡µé¢
    function changePage(delta) {
      const newPage = currentPage + delta;
      const totalPages = Math.ceil(filteredCategories.length / itemsPerPage);
      
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        updateTable();
      }
    }
    
    // åŠ è½½æœ€è¿‘è¯„æµ‹
    async function loadRecentCategories() {
      try {
        const response = await fetch('/api/recent-categories');
        const data = await response.json();
        
        const container = document.getElementById('recentCategories');
        if (data.recent_categories.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— æœ€è¿‘è¯„æµ‹æ•°æ®</div>';
          return;
        }
        
        container.innerHTML = data.recent_categories.map(cat => {
          const date = new Date(cat.evaluation_date || cat.updatedAt);
          const timeAgo = getTimeAgo(date);
          
          return `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
              <div>
                <div class="font-medium text-gray-900">${cat.item}</div>
                <div class="text-sm text-gray-500">${cat.level1} > ${cat.level2}</div>
              </div>
              <div class="text-right">
                <div class="text-sm text-gray-500">${timeAgo}</div>
                <a href="http://localhost:3077/category/${encodeURIComponent(cat.level1)}/${encodeURIComponent(cat.level2)}/${encodeURIComponent(cat.item)}" 
                   target="_blank" class="text-xs text-blue-600 hover:text-blue-800">
                  æŸ¥çœ‹
                </a>
              </div>
            </div>
          `;
        }).join('');
        
      } catch (error) {
        console.error('åŠ è½½æœ€è¿‘è¯„æµ‹å¤±è´¥:', error);
        document.getElementById('recentCategories').innerHTML = `
          <div class="text-center text-red-500 py-4">
            <i class="fas fa-exclamation-triangle mr-2"></i>åŠ è½½å¤±è´¥
          </div>
        `;
      }
    }
    
    // è·å–æ—¶é—´å·®æè¿°
    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 60) {
        return `${diffMins}åˆ†é’Ÿå‰`;
      } else if (diffHours < 24) {
        return `${diffHours}å°æ—¶å‰`;
      } else if (diffDays < 30) {
        return `${diffDays}å¤©å‰`;
      } else {
        return date.toLocaleDateString('zh-CN');
      }
    }
    
    // åˆ·æ–°æ•°æ®
    function refreshData() {
      currentPage = 1;
      loadData();
    }
    
    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    function initEventListeners() {
      document.getElementById('searchInput').addEventListener('input', () => {
        currentPage = 1;
        applyFilters();
      });
      
      document.getElementById('level1Filter').addEventListener('change', () => {
        currentPage = 1;
        applyFilters();
      });
      
      document.getElementById('level2Filter').addEventListener('change', () => {
        currentPage = 1;
        applyFilters();
      });
      
      document.getElementById('sortBy').addEventListener('change', () => {
        currentPage = 1;
        applyFilters();
      });
    }
    
    // é¡µé¢åŠ è½½å®Œæˆ
    document.addEventListener('DOMContentLoaded', () => {
      initEventListeners();
      loadData();
      
      // è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼ˆæ¯30ç§’ï¼‰
      setInterval(() => {
        const searchTerm = document.getElementById('searchInput').value;
        if (!searchTerm) { // åªåœ¨æ²¡æœ‰æœç´¢æ—¶è‡ªåŠ¨åˆ·æ–°
          loadData();
        }
      }, 30000);
    });
  </script>
</body>
</html>
